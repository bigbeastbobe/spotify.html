<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(180deg, #1e3a5f 0%, #0a0e27 100%);
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 240px;
            background: #000;
            padding: 24px 12px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            padding: 0 12px;
            letter-spacing: -1px;
        }

        .nav-item {
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 16px;
            font-weight: 600;
            color: #b3b3b3;
        }

        .nav-item:hover {
            color: #fff;
            background: #282828;
        }

        .nav-item.active {
            color: #fff;
        }

        .main-content {
            flex: 1;
            background: linear-gradient(180deg, rgba(30, 58, 95, 0.6) 0%, #121212 300px);
            overflow-y: auto;
            padding: 24px;
        }

        .auth-section {
            text-align: center;
            padding: 60px 20px;
        }

        .auth-button {
            background: #1db954;
            color: #fff;
            border: none;
            padding: 14px 32px;
            border-radius: 500px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-button:hover {
            background: #1ed760;
            transform: scale(1.04);
        }

        .search-container {
            margin-bottom: 32px;
        }

        .search-box {
            width: 100%;
            max-width: 600px;
            padding: 12px 20px;
            background: #fff;
            border: none;
            border-radius: 500px;
            font-size: 14px;
            color: #000;
        }

        .search-box:focus {
            outline: none;
        }

        .playlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .playlist-card {
            background: #181818;
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .playlist-card:hover {
            background: #282828;
            transform: translateY(-4px);
        }

        .album-art {
            width: 100%;
            aspect-ratio: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .playlist-title {
            font-weight: 600;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-artist {
            font-size: 14px;
            color: #b3b3b3;
        }

        .play-button {
            position: absolute;
            bottom: 90px;
            right: 16px;
            width: 48px;
            height: 48px;
            background: #1db954;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.3s;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            border: none;
            color: #fff;
            font-size: 20px;
        }

        .playlist-card:hover .play-button {
            opacity: 1;
            transform: translateY(0);
        }

        .play-button:hover {
            transform: scale(1.05);
            background: #1ed760;
        }

        .player {
            background: #181818;
            border-top: 1px solid #282828;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            height: 90px;
        }

        .now-playing {
            display: flex;
            align-items: center;
            gap: 16px;
            width: 240px;
        }

        .now-playing-art {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .now-playing-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .now-playing-info h4 {
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .now-playing-info p {
            font-size: 12px;
            color: #b3b3b3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .control-buttons {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .control-btn {
            background: none;
            border: none;
            color: #b3b3b3;
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px;
            font-size: 16px;
        }

        .control-btn:hover {
            color: #fff;
            transform: scale(1.1);
        }

        .control-btn.play-pause {
            width: 36px;
            height: 36px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
        }

        .control-btn.play-pause:hover {
            transform: scale(1.06);
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            max-width: 600px;
        }

        .time {
            font-size: 12px;
            color: #b3b3b3;
            min-width: 40px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: #4d4d4d;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .progress-bar:hover .progress {
            background: #1db954;
        }

        .progress {
            height: 100%;
            background: #fff;
            border-radius: 2px;
            width: 0%;
            position: relative;
        }

        .progress::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
        }

        .progress-bar:hover .progress::after {
            opacity: 1;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 240px;
            justify-content: flex-end;
        }

        .volume-bar {
            width: 100px;
            height: 4px;
            background: #4d4d4d;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .volume-level {
            height: 100%;
            background: #fff;
            border-radius: 2px;
            width: 70%;
        }

        h2 {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .greeting {
            font-size: 14px;
            color: #b3b3b3;
            margin-bottom: 24px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #b3b3b3;
        }

        .error {
            background: #ff4444;
            color: #fff;
            padding: 12px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .success {
            background: #1db954;
            color: #fff;
            padding: 12px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid #b3b3b3;
            color: #b3b3b3;
            padding: 8px 20px;
            border-radius: 500px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: auto;
        }

        .logout-btn:hover {
            border-color: #fff;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">üéµ Spotify</div>
            <nav>
                <div class="nav-item active" onclick="showHome()">üè† Home</div>
                <div class="nav-item" onclick="showSearch()">üîç Search</div>
                <div class="nav-item" onclick="showLibrary()">üìö Your Library</div>
            </nav>
            <nav style="margin-top: 24px;">
                <div class="nav-item">‚ûï Create Playlist</div>
                <div class="nav-item">‚ù§Ô∏è Liked Songs</div>
            </nav>
            <button class="logout-btn" id="logoutBtn" style="display: none;" onclick="logout()">Logout</button>
        </div>

        <div class="main-content" id="mainContent">
            <div class="auth-section" id="authSection">
                <h2 style="margin-bottom: 24px;">Connect to Spotify</h2>
                <p style="color: #b3b3b3; margin-bottom: 32px;">Log in to access your playlists and music</p>
                <button class="auth-button" onclick="authenticate()">Connect with Spotify</button>
            </div>

            <div id="contentSection" style="display: none;">
                <div class="greeting" id="greeting">Good evening</div>
                <h2 id="contentTitle">Your Music</h2>
                <div id="searchContainer" class="search-container" style="display: none;">
                    <input type="text" class="search-box" id="searchInput" placeholder="Search for songs, artists, or albums..." onkeyup="handleSearch(event)">
                </div>
                <div id="errorMessage"></div>
                <div id="successMessage"></div>
                <div id="loadingMessage" class="loading" style="display: none;">Loading...</div>
                <div class="playlist-grid" id="playlistGrid"></div>
            </div>
        </div>
    </div>

    <div class="player">
        <div class="now-playing">
            <div class="now-playing-art" id="playerArt">
                <span>üéß</span>
            </div>
            <div class="now-playing-info">
                <h4 id="trackTitle">Select a track</h4>
                <p id="trackArtist">Start playing music</p>
            </div>
        </div>

        <div class="player-controls">
            <div class="control-buttons">
                <button class="control-btn" onclick="previousTrack()">‚èÆ</button>
                <button class="control-btn play-pause" onclick="togglePlay()">
                    <span id="playIcon">‚ñ∂</span>
                </button>
                <button class="control-btn" onclick="nextTrack()">‚è≠</button>
            </div>
            <div class="progress-container">
                <span class="time" id="currentTime">0:00</span>
                <div class="progress-bar" onclick="seek(event)">
                    <div class="progress" id="progress"></div>
                </div>
                <span class="time" id="totalTime">0:00</span>
            </div>
        </div>

        <div class="volume-control">
            <span>üîä</span>
            <div class="volume-bar" onclick="setVolume(event)">
                <div class="volume-level" id="volumeLevel"></div>
            </div>
        </div>
    </div>

    <script>
        // ============ CONFIGURATION ============
        // Update these with your actual API endpoints
       const API_CONFIG = {
    BASE_URL: 'https://spotify-iz00.onrender.com',  // ‚úÖ CORRECT
            AUTH_URL: '/api/auth',               // Returns auth_url to redirect to
            CALLBACK_PATH: '/callback',          // Where Spotify redirects back
            TOKEN_URL: '/api/token',             // Exchange code for token (optional if handled in callback)
            PLAYLISTS_URL: '/api/playlists',
            SEARCH_URL: '/api/search',
            PLAY_URL: '/api/play',
            PAUSE_URL: '/api/pause',
            NEXT_URL: '/api/next',
            PREVIOUS_URL: '/api/previous',
            CURRENT_URL: '/api/current',
            SEEK_URL: '/api/seek',
            VOLUME_URL: '/api/volume'
        };

        // ============ STATE MANAGEMENT ============
        let accessToken = null;
        let refreshToken = null;
        let isAuthenticated = false;
        let isPlaying = false;
        let currentTrack = null;
        let updateInterval = null;

        // ============ INITIALIZATION ============
        window.addEventListener('DOMContentLoaded', () => {
            handleCallback();
            checkExistingAuth();
        });

        // ============ AUTHENTICATION ============
        
        // Check if already authenticated
        function checkExistingAuth() {
            const token = getTokenFromMemory();
            if (token) {
                accessToken = token;
                isAuthenticated = true;
                showAuthenticatedUI();
            }
        }

        // Handle OAuth callback from URL
        function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('access_token');
            const refresh = urlParams.get('refresh_token');
            const error = urlParams.get('error');

            if (error) {
                showError('Authentication failed: ' + error);
                return;
            }

            if (token) {
                accessToken = token;
                if (refresh) refreshToken = refresh;
                
                // Store in memory
                storeTokenInMemory(token, refresh);
                
                isAuthenticated = true;
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                showSuccess('Successfully connected to Spotify!');
                showAuthenticatedUI();
            }
        }

        // Start authentication flow
        async function authenticate() {
            try {
                const response = await fetch(API_CONFIG.BASE_URL + API_CONFIG.AUTH_URL);
                const data = await response.json();
                
                if (data.auth_url) {
                    // Redirect to Spotify authorization
                    window.location.href = data.auth_url;
                } else if (data.access_token) {
                    // Direct token response (if your backend handles it differently)
                    accessToken = data.access_token;
                    if (data.refresh_token) refreshToken = data.refresh_token;
                    storeTokenInMemory(accessToken, refreshToken);
                    isAuthenticated = true;
                    showAuthenticatedUI();
                }
            } catch (error) {
                showError('Failed to start authentication. Check your API configuration.');
                console.error('Auth error:', error);
            }
        }

        // Logout
        function logout() {
            accessToken = null;
            refreshToken = null;
            isAuthenticated = false;
            clearTokenFromMemory();
            
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('contentSection').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            
            showSuccess('Logged out successfully');
        }

        // Show authenticated UI
        function showAuthenticatedUI() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('contentSection').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
            loadPlaylists();
            startPlaybackUpdates();
        }

        // ============ TOKEN STORAGE (IN-MEMORY) ============
        let tokenStorage = {
            access_token: null,
            refresh_token: null
        };

        function storeTokenInMemory(access, refresh) {
            tokenStorage.access_token = access;
            tokenStorage.refresh_token = refresh;
        }

        function getTokenFromMemory() {
            return tokenStorage.access_token;
        }

        function clearTokenFromMemory() {
            tokenStorage.access_token = null;
            tokenStorage.refresh_token = null;
        }

        // ============ API CALLS ============

        // Generic API call with auth header
        async function apiCall(url, options = {}) {
            const headers = {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json',
                ...options.headers
            };

            try {
                const response = await fetch(API_CONFIG.BASE_URL + url, {
                    ...options,
                    headers
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showError('Session expired. Please login again.');
                        logout();
                        return null;
                    }
                    throw new Error(`API call failed: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API call error:', error);
                return null;
            }
        }

        // Load user's playlists
        async function loadPlaylists() {
            showLoading(true);
            const data = await apiCall(API_CONFIG.PLAYLISTS_URL);
            if (data) {
                displayPlaylists(data.items || data.playlists || data);
            }
            showLoading(false);
        }

        // Display playlists/tracks
        function displayPlaylists(items) {
            const grid = document.getElementById('playlistGrid');
            grid.innerHTML = '';

            if (!items || items.length === 0) {
                grid.innerHTML = '<p style="color: #b3b3b3; grid-column: 1/-1; text-align: center;">No items found</p>';
                return;
            }

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'playlist-card';
                
                const imageUrl = item.images?.[0]?.url || item.album?.images?.[0]?.url || '';
                const name = item.name || item.track?.name || 'Unknown';
                const artist = item.owner?.display_name || item.artists?.[0]?.name || item.album?.artists?.[0]?.name || 'Unknown Artist';
                const uri = item.uri || item.id || '';
                
                card.innerHTML = `
                    <div class="album-art">
                        ${imageUrl ? `<img src="${imageUrl}" alt="${name}">` : '<span style="font-size: 48px;">üéµ</span>'}
                    </div>
                    <button class="play-button" onclick='playItem(${JSON.stringify({uri, name, artist, imageUrl})})'>‚ñ∂</button>
                    <div class="playlist-title">${escapeHtml(name)}</div>
                    <div class="playlist-artist">${escapeHtml(artist)}</div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Play a track/playlist
        async function playItem(item) {
            const data = await apiCall(API_CONFIG.PLAY_URL, {
                method: 'POST',
                body: JSON.stringify({ uri: item.uri })
            });

            if (data) {
                updateNowPlaying(item.name, item.artist, item.imageUrl);
                isPlaying = true;
                document.getElementById('playIcon').textContent = '‚è∏';
            }
        }

        // Toggle play/pause
        async function togglePlay() {
            const url = isPlaying ? API_CONFIG.PAUSE_URL : API_CONFIG.PLAY_URL;
            const data = await apiCall(url, { method: 'POST' });

            if (data !== null) {
                isPlaying = !isPlaying;
                document.getElementById('playIcon').textContent = isPlaying ? '‚è∏' : '‚ñ∂';
            }
        }

        // Next track
        async function nextTrack() {
            await apiCall(API_CONFIG.NEXT_URL, { method: 'POST' });
            setTimeout(updatePlaybackState, 500);
        }

        // Previous track
        async function previousTrack() {
            await apiCall(API_CONFIG.PREVIOUS_URL, { method: 'POST' });
            setTimeout(updatePlaybackState, 500);
        }

        // Seek to position
        async function seek(event) {
            if (!currentTrack?.duration_ms) return;
            
            const bar = event.currentTarget;
            const clickX = event.offsetX;
            const width = bar.offsetWidth;
            const percentage = (clickX / width);
            const position_ms = Math.floor(percentage * currentTrack.duration_ms);
            
            await apiCall(API_CONFIG.SEEK_URL, {
                method: 'POST',
                body: JSON.stringify({ position_ms })
            });
        }

        // Set volume
        async function setVolume(event) {
            const bar = event.currentTarget;
            const clickX = event.offsetX;
            const width = bar.offsetWidth;
            const volume = Math.floor((clickX / width) * 100);
            
            document.getElementById('volumeLevel').style.width = volume + '%';
            
            await apiCall(API_CONFIG.VOLUME_URL, {
                method: 'POST',
                body: JSON.stringify({ volume_percent: volume })
            });
        }

        // Update playback state
        async function updatePlaybackState() {
            if (!isAuthenticated) return;

            const data = await apiCall(API_CONFIG.CURRENT_URL);
            
            if (data && data.item) {
                currentTrack = data.item;
                isPlaying = data.is_playing || false;
                
                updateNowPlaying(
                    data.item.name,
                    data.item.artists?.map(a => a.name).join(', ') || 'Unknown',
                    data.item.album?.images?.[0]?.url
                );
                
                document.getElementById('playIcon').textContent = isPlaying ? '‚è∏' : '‚ñ∂';
                
                // Update progress
                if (data.item.duration_ms) {
                    const progress = (data.progress_ms / data.item.duration_ms) * 100;
                    document.getElementById('progress').style.width = progress + '%';
                    document.getElementById('currentTime').textContent = formatTime(data.progress_ms);
                    document.getElementById('totalTime').textContent = formatTime(data.item.duration_ms);
                }
            }
        }

        // Start periodic updates
        function startPlaybackUpdates() {
            updatePlaybackState();
            updateInterval = setInterval(updatePlaybackState, 1000);
        }

        // ============ SEARCH ============
        let searchTimeout;
        async function handleSearch(event) {
            clearTimeout(searchTimeout);
            
            const query = event.target.value.trim();
            if (!query) {
                document.getElementById('playlistGrid').innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(async () => {
                showLoading(true);
                const data = await apiCall(`${API_CONFIG.SEARCH_URL}?q=${encodeURIComponent(query)}`);
                if (data) {
                    displayPlaylists(data.tracks?.items || data.items || data);
                }
                showLoading(false);
            }, 500);
        }

        // ============ NAVIGATION ============
        function showHome() {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('searchContainer').style.display = 'none';
            document.getElementById('contentTitle').textContent = 'Your Music';
            if (isAuthenticated) loadPlaylists();
        }

        function showSearch() {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('searchContainer').style.display = 'block';
            document.getElementById('contentTitle').textContent = 'Search';
            document.getElementById('searchInput').value = '';
            document.getElementById('playlistGrid').innerHTML = '';
        }

        function showLibrary() {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('searchContainer').style.display = 'none';
            document.getElementById('contentTitle').textContent = 'Your Library';
            if (isAuthenticated) loadPlaylists();
        }

        // ============ UI UPDATES ============
        function updateNowPlaying(title, artist, imageUrl) {
            document.getElementById('trackTitle').textContent = title || 'Unknown Track';
            document.getElementById('trackArtist').textContent = artist || 'Unknown Artist';
            
            const artElement = document.getElementById('playerArt');
            if (imageUrl) {
                artElement.innerHTML = `<img src="${imageUrl}" alt="${title}">`;
            } else {
                artElement.innerHTML = '<span>üéß</span>';
            }
        }

        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
            setTimeout(() => {
                errorDiv.innerHTML = '';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.innerHTML = `<div class="success">${escapeHtml(message)}</div>`;
            setTimeout(() => {
                successDiv.innerHTML = '';
            }, 3000);
        }

        // ============ UTILITY FUNCTIONS ============
        function formatTime(ms) {
            if (!ms) return '0:00';
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>